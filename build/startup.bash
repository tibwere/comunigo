#!/bin/bash

usage() {
    echo "Usage: ${0} [OPTIONS]"
    echo "Options:"
    echo -e "\tFLAG   VALUES                             DESCRIPTION                REQUIRED/OPTIONAL"
    echo -e "\t-n     <number-of-peers>                  Number of peers to spawn   {REQUIRED}"
    echo -e "\t-t     [sequencer | scalar | vectorial]   Algorithm to use           {REQUIRED}"
    echo -e "\t-v                                        Verbose modality           {OPTIONAL, default disabled}"
    echo -e "\t-a                                        Attach containers          {OPTIONAL, default false}"
}

SIZE=3
PROVIDED_SIZE=0
VERBOSE=false
DC_FILE="./docker-compose.yml"
CONFIG_FILE="./comunigo.cfg"
ENV_FILE="./.env"
TOS=""
PROJ_NAME=comunigo
DETACH="-d"

# Parse command line options
while getopts ":hn:vt:a" opt; do
    case ${opt} in
        h ) 
            usage
            exit 0
            ;;
        n )
            PROVIDED_SIZE=1
            SIZE=$OPTARG
            ;;
        v )
            VERBOSE=true
            ;;
        t )
            TOS=${OPTARG}
            ;;
        a )
            DETACH=""
            ;;
        ? )
            usage
            exit 1 
    esac
done
shift $((OPTIND -1))

# Dump of configurations 
if [ "${TOS}" != "sequencer" ] && [ "${TOS}" != "scalar" ] && [ "${TOS}" != "vectorial" ]; then
    echo "[!] Select a valid type of service: sequencer | scalar | vectorial"
    exit 1
fi

echo -e "[+] SUMMARY"

if [ "${PROVIDED_SIZE}" == "0" ]; then
    echo -e "\t[*] Number of peers...........: ${SIZE} (default value)"
else
    echo -e "\t[*] Number of peers...........: ${SIZE}"
fi
 
if [ "$VERBOSE" == "true" ]; then
    echo -e "\t[*] Verbose output on log.....: ENABLED"
else 
    echo -e "\t[*] Verbose output on log.....: DISABLED"
fi

echo -e "\t[*] Type of service...........: ${TOS}"
echo -e "\t[*] Configuration file........: ${CONFIG_FILE}"
echo -e "\t[*] Environment variables file: ${ENV_FILE}"
echo -e "\t[*] YAML file.................: ${DC_FILE}"

# Load environment file
echo -e "# DO NOT EDIT THIS FILE IS AUTOGENERATED\n" > ${ENV_FILE}
cat ${CONFIG_FILE} >> ${ENV_FILE}
echo -e "\n\nVERBOSE=${VERBOSE}" >> ${ENV_FILE}
echo "TOS=${TOS}" >> ${ENV_FILE}
echo "SIZE=${SIZE}" >> ${ENV_FILE}
echo "[+] Created environment file for docker-compose"

# Run containers
echo -e "[+] Startup ${SIZE} peers, sequencer and register services ..."
docker-compose -f ${DC_FILE} --env-file ${ENV_FILE} --project-name ${PROJ_NAME} up ${DETACH} --scale peer_ms=${SIZE} --build

